var util = require('./util');

/**
 * Returns the app in which the file is located
 * @param {String/Node} file A file path or Node
 * @returns {Object}
 */
module.exports = function appFor(node) {
    var file;

    if (typeof(node) === 'string') {
        file = node.toLowerCase();
    } else {
        file = node.sourceFile.name.toLowerCase();
    }

    var apps = global.tern.apps,
        sdkPaths = [].concat(global.tern.sdks.map(function(sdk) { return sdk.path })),
        cwd = process.cwd();

    for (var i=0; i<apps.length; i++) {
        var app = apps[i];
        if (util.startsWithIgnoreCase(file, app.path)) return app;
        if (app.sdk && app.sdk.path) sdkPaths.push(app.sdk.path);
    }

    // If there is only one app in the project which is not inside of an sdk, return it
    // This allows us to run app watch correctly from anywhere in the project in Visual Studio Code.
    var appsInProject = apps.filter(function(app) {
        return util.startsWithIgnoreCase(app.path, cwd) && !sdkPaths.some(function(sdk) {
            return util.startsWithIgnoreCase(app.path, sdk)
        });
    });

    if (appsInProject.length === 1) return appsInProject[0];
};

